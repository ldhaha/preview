<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>
	<body></body>
</html>

<script>
	let activeEffect;

	const effectStack = [];

	let bucket = new WeakMap();

	const data = { ok: true, title: 'lindong', foo: 0 };

	const obj = new Proxy(data, {
		get(target, key) {
			if (!activeEffect) return target[key];
			track(target, key);
			return target[key];
		},
		set(target, key, value) {
			target[key] = value;
			trigger(target, key);
		},
	});

	function track(target, key) {
		if (!activeEffect) return;
		let depsMap = bucket.get(target);
		if (!depsMap) {
			bucket.set(target, (depsMap = new Map()));
		}
		let depsSet = depsMap.get(key);
		if (!depsSet) {
			depsMap.set(key, (depsSet = new Set()));
		}
		depsSet.add(activeEffect);
		activeEffect.deps.push(depsSet);
	}

	function trigger(target, key) {
		const depsMap = bucket.get(target);
		if (!depsMap) return;
		const effects = depsMap.get(key);
		// effect.forEach(fn => fn())
		const effestsToRun = new Set();
		effects.forEach(fn => {
			if (fn !== activeEffect) {
				effestsToRun.add(fn);
			}
		});
		effestsToRun?.forEach(fn => fn());
	}

	function effect(fn) {
		const effectFn = () => {
			cleanUp(effectFn);
			effectStack.push(effectFn);
			activeEffect = effectFn;
			fn();
			effectStack.pop();
			activeEffect = effectStack[effectStack.length - 1];
			console.log(activeEffect);
		};
		effectFn.deps = [];
		effectFn();
	}

	function cleanUp(effectFn) {
		for (let i = 0; i < effectFn.deps.length; i++) {
			const depsSet = effectFn.deps[i];
			depsSet.delete(effectFn);
		}
		effectFn.deps.length = 0;
	}

	effect(() => {
		obj.foo = obj.foo + 1;
	});
</script>
